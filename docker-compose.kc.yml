services:
  # postgres:
  #   image: postgres:18.0-alpine
  #   container_name: kc-postgres
  #   environment:
  #     POSTGRES_USER: keycloak
  #     POSTGRES_PASSWORD: keycloak
  #     POSTGRES_DB: keycloak
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped
  #   networks:
  #     - infra-network

  keycloak:
    image: hzeroxium/keycloak-custom:26.4.0
    container_name: keycloak
    build:
      context: ./config-control-service/keycloak
      dockerfile: Dockerfile.keycloak
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    environment:
      # Bootstrap admin (bắt buộc khi chạy container)
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin

      # Database
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://10.40.30.161:25432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak

      # Hostname configuration
      KC_HOSTNAME: keycloak
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"

      # Tối ưu/giám sát
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_PROXY: "passthrough"

      # Optional but explicit (if supported by your Keycloak version)
      KC_HOSTNAME_URL: http://keycloak:8080

    command:
      - start-dev
      - --log-level=com.example.keycloak.login:DEBUG,com.example.keycloak.registration:DEBUG,root:INFO

    ports:
      - "8080:8080" # HTTP (dev)
      - "9000:9000" # health/metrics
    volumes:
      - keycloak_data:/opt/keycloak/data
    restart: unless-stopped
    # Healthcheck Keycloak (ready) - disabled for now
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z localhost 9000 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - infra-network

  # Keycloak initialization service
  keycloak-init:
    image: keycloak-init
    build:
      context: ./config-control-service/keycloak
      dockerfile: Dockerfile
    container_name: keycloak-init
    depends_on:
      - keycloak
    networks:
      - infra-network
    restart: "no"
    environment:
      - KEYCLOAK_API_URL=http://keycloak:8080
      - KEYCLOAK_HEALTH_URL=http://keycloak:9000
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin

  # Mailpit for email testing (dev)
  mailpit:
    image: axllent/mailpit:v1.27
    container_name: mailpit
    ports:
      - "8025:8025" # Web UI
      - "1025:1025" # SMTP
    networks:
      - infra-network
    restart: unless-stopped

volumes:
  keycloak_data:

networks:
  infra-network:
    external: true
    name: infra-network
