// shared-common/build.gradle

plugins {
    id 'java'
    id 'idea'
    id 'org.springframework.boot' version '3.3.13' apply false
    id 'io.spring.dependency-management' version '1.1.6'
}

apply plugin: 'io.spring.dependency-management'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

group = 'com.example'
version = '1.0.0'

repositories {
    mavenCentral()
}

dependencyManagement {
    imports {
        mavenBom 'org.springframework.boot:spring-boot-dependencies:3.3.13'
    }
}

dependencies {
    // Thrift dependencies
    implementation 'org.apache.thrift:libthrift:0.22.0'
    compileOnly 'javax.annotation:javax.annotation-api:1.3.2'
    
    // SLF4J for generated Thrift code
    implementation 'org.slf4j:slf4j-api'
    
    // Spring Boot dependencies for Kafka and common configs
    implementation 'org.springframework.boot:spring-boot-starter'
    implementation 'org.springframework.kafka:spring-kafka'
    implementation 'org.apache.kafka:kafka-clients'
    
    // Spring Cache + Redis for shared cache config
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'io.lettuce:lettuce-core'
    implementation 'com.github.ben-manes.caffeine:caffeine'
    
    // Jackson for JSON processing
    implementation 'com.fasterxml.jackson.core:jackson-databind'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'
    
    // Validation
    implementation 'jakarta.validation:jakarta.validation-api'

    // OpenAPI/Swagger annotations for DTOs
    implementation 'io.swagger.core.v3:swagger-annotations:2.2.22'
    
    // Micrometer for shared profiling config
    implementation 'io.micrometer:micrometer-core'
    implementation 'io.micrometer:micrometer-registry-prometheus'
    
    // AOP for shared profiling config
    implementation 'org.springframework:spring-aop'
    implementation 'org.aspectj:aspectjweaver'
    
    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    
    // Test dependencies
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testImplementation 'org.assertj:assertj-core'
    testImplementation 'org.mockito:mockito-core'
    testImplementation 'org.mockito:mockito-junit-jupiter'
    testImplementation 'jakarta.validation:jakarta.validation-api'
}

// Thrift version configuration
ext {
    thriftVersion = '0.22.0'
}

// Thrift source directory
def thriftSrcDir = file('src/main/thrift')

// Generated sources directory
def generatedSourcesDir = file('build/generated-sources/thrift')

// Source sets configuration
sourceSets {
    main {
        java {
            srcDirs = [
                'src/main/java',
                generatedSourcesDir
            ]
        }
        resources.srcDirs = ['src/main/resources']
    }
    test {
        java.srcDirs = ['src/test/java']
        resources.srcDirs = ['src/test/resources']
    }
}

// Thrift generation task
tasks.register('generateThrift', Exec) {
    group = 'thrift'
    description = 'Generate Java classes from Thrift definitions'
    
    inputs.dir(thriftSrcDir)
    outputs.dir(generatedSourcesDir)
    
    doFirst {
        generatedSourcesDir.mkdirs()
        if (!thriftSrcDir.exists()) {
            throw new GradleException("Thrift source directory does not exist: ${thriftSrcDir}")
        }
    }
    
    // Find thrift files
    def thriftFiles = []
    if (thriftSrcDir.exists()) {
        thriftSrcDir.eachFileRecurse { f ->
            if (f.isFile() && f.name.endsWith('.thrift')) {
                thriftFiles.add(f)
            }
        }
    }
    
    if (thriftFiles.isEmpty()) {
        // No thrift files found, create empty directory
        generatedSourcesDir.mkdirs()
        return
    }
    
    // Execute thrift for each file
    executable 'thrift'
    args '-r', '--gen', 'java', '-out', generatedSourcesDir.absolutePath
    args thriftFiles.collect { it.absolutePath }
}

// Compile Java depends on Thrift generation
compileJava {
    dependsOn tasks.named('generateThrift')
    options.encoding = 'UTF-8'
}

// Clean task to remove generated sources
clean {
    delete generatedSourcesDir
}

// JAR task to include generated sources
jar {
    from generatedSourcesDir
    archiveBaseName = 'shared-common'
    archiveVersion = version
}

// Publishing configuration (optional - for future use)
// publishing {
//     publications {
//         maven(MavenPublication) {
//             from components.java
//             groupId = group
//             artifactId = 'shared-thrift-definitions'
//             version = version
//         }
//     }
// }
